const token=localStorage.getItem("token"),queryString=window.location.search,urlParams=new URLSearchParams(queryString),chatroomBirthday=urlParams.get("birthday");primus=Primus.connect(`http://localhost:3000/?chatroomBirthday=${chatroomBirthday}`,{reconnect:{max:1/0,min:500,retries:10}}),primus.on("data",e=>{"sendMessage"===e.action&&e.message.chatroom_birthday===chatroomBirthday&&appendMessage(e.message)}),fetch("/users/getUsersByBirthday",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify({birthday:chatroomBirthday})}).then(e=>e.json()).then(e=>{var t=e.data.users.length;document.querySelector("#birthdaySharersAmount").innerHTML=t,e.data.users.forEach(e=>{e=`<li class="list__item">${e.username}</li>`;document.querySelector("#birthdaySharers").insertAdjacentHTML("beforeEnd",e)})}),fetch("/chat/getMessagesByChatroom",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify({chatroomBirthday:chatroomBirthday})}).then(e=>e.json()).then(e=>{chatRoomMessages=[],e.data.messages.forEach(e=>{chatRoomMessages.push(e)}),chatRoomMessages.sort((e,t)=>e.time_sent-t.time_sent),chatRoomMessages.forEach(e=>{appendMessage(e)})});let sendMessageButton=document.querySelector("#sendMessageButton").addEventListener("click",e=>{var t=document.querySelector("#messageContent").value,a=Date.now();fetch("/chat",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${token}`},body:JSON.stringify({content:t,time_sent:a})}).then(e=>e.json()).then(e=>{e=e.data.message;primus.write({action:"sendMessage",message:e})})}),appendMessage=e=>{let t=new Date(parseInt(e.time_sent));var a=t.getDate()+"/"+(t.getMonth()+1)+"/"+t.getFullYear()+" "+t.getHours()+":"+t.getMinutes(),e=`<li class="chat__item"><h4 class="chat__sender">${e.sender}</h4><p class="chat__time">${a}</p><p class="chat__content">${e.content}</p></li>`;document.querySelector("#chatMessages").insertAdjacentHTML("afterBegin",e)};